---
title: "Patterns of reef fish energy flow in a transitional zone"
author: "Liu et al. 2025"
date: "2025-07-30"
output: html_document
---

```{r, setup, include=FALSE}
knitr::opts_chunk$set(
  message = FALSE, error = FALSE, warning = FALSE, fig.align = 'center'
)

```

```{r}
#Set working directory to the code source
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))

library(tidyverse)
library(vegan)
library(glmmTMB)
library(emmeans)
library(ggpubr)
library(DHARMa)
library(performance)

```

### Fish data manipulation

1.  Import fish metrics

```{r}
#Import fish energy metrics previously evaluated
fish.metric <- read.csv('Data/Taiwan fish metric.csv')
```

2.  Data filtration

```{r}
fish.metric <- fish.metric %>%
  #Removed 5 percent of fish that is too small for identification
  filter(Length >= 2.5) %>% 
  #Remove cryptobenthic fish family defined by Brandl et al (2018)
  filter(!Family %in% c('Pseudochromidae', 'Blenniidae')) %>%
  #Keep the order of region and sites
  mutate(Site = factor(Site, levels = unique(Site)),
         Region = factor(Region, levels = c('NT', 'ET', 'GI', 'OI', 'KT')),
         Species = factor(Species, levels = unique(Species)),
         #Combine site and transect information
         Abr = str_sub(Site, start = 1, end = 4)) %>%
  #Combine site and transect labels
  unite('Transect', c(Abr, Transect), sep = '', remove = T) %>%
  mutate(Transect = factor(Transect, levels = unique(Transect)))


head(fish.metric, 3)
```

3.  Species richness

```{r}
#Total species richness
fish.metric %>%
  distinct(Species) %>%
  count()

#Richness per site
fish.metric %>%
  group_by(Site) %>%
  distinct(Species) %>%
  count() %>%
  ungroup() %>%
  summarise(Number = mean(n),
            SD = sd(n))

#Richness per region
fish.metric %>%
  group_by(Region) %>%
  distinct(Species) %>%
  count() %>%
  ungroup() %>%
  summarise(Number = mean(n),
            SD = sd(n))

#Richness of the five region
fish.metric %>%
  group_by(Region) %>%
  distinct(Species) %>%
  count()

```

4.  Calculate transect-level energy flow metrics

```{r}
transect.energy <- fish.metric %>%
  group_by(Region, Site, Transect) %>%
  #100 is the detecting area of each transect
  #so the values are energy flows per m^2
  summarise(Biom = sum(Biomass)/100,
            #Growth_iter represents the average somatic growth across 100 iterations following survival simulations
            Prod = sum(Growth_iter)/100, 
            Turn = Prod/Biom * 100,
            .groups = 'drop')

head(transect.energy, 3)
```

### Global comparison of energy flows

```{r, fig.width = 8, fig.height = 5}
#Data from 'Seguin et al. (2023) Towards process-oriented management of tropical reefs in the anthropocene'
global.energy <- read.csv(file = 'Data/Global fish metric.csv')

#Mean energy flows in each sites
taiwan.energy <- fish.metric %>%
  group_by(Region, Site, Transect) %>%
  #100 is the detecting area of each transect
  #so the values are energy flows per m^2
  summarise(Biom = sum(Biomass)/100,
            #Sum of somatic growth of surviving fish
            #Growth_iter represents the average somatic growth across 100 iterations following survival simulations
            Prod = sum(Growth_iter)/100, 
            Turn = Prod/Biom * 100,
            .groups = 'drop') %>%
  #Biomass were log transformed
  mutate(Biom = log10(Biom + 1)) %>%
  ungroup() %>%
  group_by(Site) %>%
  summarise(Biom = mean(Biom),
            Prod = mean(Prod),
            Turn = mean(Turn),
            Country = 'Taiwan',
            .groups = 'drop') %>%
  #Rename column name to fit Seguin's data
  rename('SiteCode' = 'Site')

#Combine global and Taiwan data
global.taiwan <- global.energy %>%
  #Select depth between 3 - 7 meters
  filter(Depth > 3 & Depth < 7) %>%
  group_by(SurveyID) %>%
  #Sum of energy flows in each transect
  #500 m^2 are detecting areas in RLS
  reframe(Biom = sum(Biom)/500,
          #Growth_iter represents the average somatic growth across 100 iterations following survival simulations
          Prod = sum(Growth_iter * Num)/500,
          Turn = (Prod/Biom)*100,
          Country = Country,
          SiteCode = SiteCode) %>%
  distinct() %>%
  ungroup() %>%
  #Mean energy flows of each site
  group_by(SiteCode) %>%
  reframe(Biom = mean(Biom),
          Prod = mean(Prod),
          Turn = mean(Turn),
          Country = Country) %>%
  mutate(Biom = log10(Biom + 1)) %>%
  ungroup() %>%
  #Combine Taiwan data
  add_row(taiwan.energy) %>%
  #Extract nearby countries for comparison
  mutate(Col = ifelse(Country %in% c('Taiwan', 'Japan', 'Indonesia'),
                      Country, 'Others')) %>%
  #Labeling the text of each site of Taiwan
  mutate(Text = ifelse(Country == 'Taiwan', SiteCode, '')) %>%
  filter(is.na(Country) == F)

#Number of sites other than Taiwan
global.taiwan %>%
  filter(Country != 'Taiwan') %>%
  distinct(SiteCode) %>%
  count()

#Mean turnover in Taiwan
global.taiwan %>%
  filter(Country == 'Taiwan') %>%
  summarise(Mean = mean(Turn),
            SD = sd(Turn))

#Global standard of high turnover
global.taiwan %>%
  summarise(Quantile75 = quantile(Turn, 0.75),
            SD = sd(Turn))

#Taiwan sites that are in high turnover units
global.taiwan %>%
  filter(Country == 'Taiwan' & Turn > quantile(global.taiwan$Turn, 0.75)) %>%
  distinct(SiteCode)

#Check which country were removed from the plot
global.taiwan %>%
  filter(Turn > 1)

#Global management units
global.taiwan %>%
  ggplot(aes(x = Biom, y = Turn, col = Col)) +
  scale_colour_manual(values = c('#7fc97f', '#beaed4', '#fdc086', '#80b1d3'),
                      aesthetics = c('colour', 'fill'),
                      labels = c('Indonesia','Japan','Others','Taiwan')) +
  #Circle the dots of every country
  stat_ellipse(geom = 'polygon', alpha = 0.3, aes(fill = Col)) +
  geom_jitter(data = global.taiwan[which(global.taiwan$Col != 'Others'), ], size = 2.5, alpha = 0.75) +
  #Lines to distinguish high turnover, high biomass, and low biomass-turnover states
  geom_segment(aes(x = -0.7, y = quantile(Turn, 0.25),
                   xend = quantile(Biom, 0.25), yend = quantile(Turn, 0.25)),
               linewidth = 0.5, col = 'grey50', linetype = 2, alpha = 0.1)+
  geom_segment(aes(x = -0.7, y = quantile(Turn, 0.75),
                   xend = 4, yend = quantile(Turn, 0.75)),
               linewidth = 0.5, col = 'grey50', linetype = 2, alpha = 0.1)+
  geom_segment(aes(x = quantile(Biom, 0.25), y = -0.1,
                   xend = quantile(Biom, 0.25), yend = quantile(Turn, 0.25)),
               linewidth = 0.5, col = 'grey50', linetype = 2, alpha = 0.1)+
  geom_segment(aes(x = quantile(Biom, 0.95), y = -0.1,
                   xend = quantile(Biom, 0.95), yend = quantile(Turn, 0.75)),
               linewidth = 0.5, col = 'grey50', linetype = 2, alpha = 0.1) +
  labs(x = expression(log[10]*'[Biomass ('~ g%.%m^-2~ ')]'),
       y = expression(Turnover~ ('%'~~day^-1)), fill = 'Country', colour = 'Country') +
  #Remove extreme outliers to improve visualization
  scale_x_continuous(limits=c(-0.7, 4), expand = c(0, 0)) +
  scale_y_continuous(limits=c(-0.1, 1), expand = c(0, 0)) +
  theme_bw(base_size = 12) +
  theme(panel.grid = element_blank(),
        axis.title = element_text(size = 14),
        title = element_text(size = 14),
        legend.title = element_text(size = 14))
#ggsave(filename = 'Fig 2.svg', width = 8, height = 5, dpi = 1200)
```

### Regional comparison of energy flows

1. QQ-plot & histogram of transect-level energy flow metrics

```{r, fig.width = 7, fig.height = 8}

#Biomass
trans.biom.qq <- transect.energy %>%
  ggplot(aes(sample = Biom)) +
  stat_qq(pch = 1, cex = 2) +
  stat_qq_line() +
  labs(x = 'Theoretical Quantiles', y = 'Sample Quantiles', subtitle = 'a') +
  theme_bw() +
  theme(panel.grid = element_blank(),
        plot.subtitle = element_text(size = 16))

trans.biom.density <- transect.energy %>%
  ggplot(aes(x = Biom)) +
  geom_histogram(aes(y = after_stat(density)), col = 'black', fill = 'grey75', bins = 15) +
  geom_density() +
  labs(x = expression(Biomass~ ~(g%.%m^-2)), y = 'Density', subtitle = ' ') +
  theme_bw() +
  theme(panel.grid = element_blank())

#Productivity
trans.prod.qq <- transect.energy %>%
  ggplot(aes(sample = Prod)) +
  stat_qq(pch = 1, cex = 2) +
  stat_qq_line() +
  labs(x = 'Theoretical Quantiles', y = 'Sample Quantiles', subtitle = 'b') +
  theme_bw() +
  theme(panel.grid = element_blank(),
        plot.subtitle = element_text(size = 16))

trans.prod.density <- transect.energy %>%
  ggplot(aes(x = Prod)) +
  geom_histogram(aes(y = after_stat(density)), col = 'black', fill = 'grey75', bins = 15) +
  geom_density() +
  labs(x = expression(Productivity~ ~(g%.%m^-2~~day^-1)), y = 'Density', subtitle = ' ') +
  theme_bw() +
  theme(panel.grid = element_blank())

#Turnover
trans.turn.qq <- transect.energy %>%
  ggplot(aes(sample = Turn)) +
  stat_qq(pch = 1, cex = 2) +
  stat_qq_line() +
  labs(x = 'Theoretical Quantiles', y = 'Sample Quantiles', subtitle = 'c') +
  theme_bw() +
  theme(panel.grid = element_blank(),
        plot.subtitle = element_text(size = 16))

trans.turn.density <- transect.energy %>%
  ggplot(aes(x = Turn)) +
  geom_histogram(aes(y = after_stat(density)), col = 'black', fill = 'grey75', bins = 15) +
  geom_density() +
  labs(x = expression(Turnover~('%'~~day^-1)), y = 'Density', subtitle = ' ') +
  theme_bw() +
  theme(panel.grid = element_blank())

ggarrange(trans.biom.qq, trans.biom.density, trans.prod.qq, trans.prod.density, trans.turn.qq, trans.turn.density, nrow = 3, ncol = 2, align = 'hv')
#ggsave(filename = 'Fig S1.svg', height = 8, width = 7, units = 'in', dpi = 1200)

```

2.  Generalized Linear Mixed Models (GLMMs)

```{r}
###Biomass
#GLMM
biom.m.reg <- glmmTMB(Biom ~ Region + (1|Site) - 1, data = transect.energy, family = ziGamma(link = 'log'))

#Save the GLMM output
biom.reg.ci <- confint(biom.m.reg) %>%
  as.data.frame() %>%
  rownames_to_column(var = 'Independent') %>%
  select(-Estimate) %>%
  rename('Lower_limit' = `2.5 %`,
         'Upper_limit' = `97.5 %`) %>%
  filter(!Independent %in% c("Std.Dev.(Intercept)|Site"))

biom.glmm.reg <- coef(summary(biom.m.reg))$cond %>%
  as.data.frame() %>%
  rownames_to_column(var = 'Independent') %>%
  mutate(Dependent = 'Biomass') %>%
  left_join(., biom.reg.ci, by = 'Independent') %>%
  relocate(Dependent)

### Productivity
#GLMM
prod.m.reg <- glmmTMB(Prod ~ Region + (1|Site) - 1, data = transect.energy, family = ziGamma(link = 'log'))

#Save the GLMM output
prod.reg.ci <- confint(prod.m.reg) %>%
  as.data.frame() %>%
  rownames_to_column(var = 'Independent') %>%
  select(-Estimate) %>%
  rename('Lower_limit' = `2.5 %`,
         'Upper_limit' = `97.5 %`) %>%
  filter(!Independent %in% c("Std.Dev.(Intercept)|Site"))

prod.glmm.reg <- coef(summary(prod.m.reg))$cond %>%
  as.data.frame() %>%
  rownames_to_column(var = 'Independent') %>%
  mutate(Dependent = 'Productivity') %>%
  left_join(., prod.reg.ci, by = 'Independent') %>%
  relocate(Dependent)

### Turnover
#GLMM
turn.m.reg <- glmmTMB(Turn ~ Region + (1|Site) - 1, data = transect.energy, family = ziGamma(link = 'log'))

#Combine the GLMM output
turn.reg.ci <- confint(turn.m.reg) %>%
  as.data.frame() %>%
  rownames_to_column(var = 'Independent') %>%
  select(-Estimate) %>%
  rename('Lower_limit' = `2.5 %`,
         'Upper_limit' = `97.5 %`) %>%
  filter(!Independent %in% c("Std.Dev.(Intercept)|Site"))

turn.glmm.reg <- coef(summary(turn.m.reg))$cond %>%
  as.data.frame() %>%
  rownames_to_column(var = 'Independent') %>%
  mutate(Dependent = 'Turnover') %>%
  left_join(., turn.reg.ci, by = 'Independent') %>%
  relocate(Dependent)

#Save the GLMM output
energy.reg.glmm <- bind_rows(biom.glmm.reg, prod.glmm.reg, turn.glmm.reg) %>%
  mutate(across(where(is.numeric) & !`Pr(>|z|)`, ~ sprintf("%.2f", .x)),
         `Pr(>|z|)` = round(`Pr(>|z|)`, 3),
         Independent = gsub("^Region", '', Independent)) %>%
  mutate(`Pr(>|z|)` = ifelse(`Pr(>|z|)` == 0, '<0.001*',
                             ifelse(`Pr(>|z|)` >= 0.05, `Pr(>|z|)`, paste0(`Pr(>|z|)`, '*')))) %>%
  relocate(Lower_limit, Upper_limit, .after = `Std. Error`)

head(energy.reg.glmm, 3)
#write.table(energy.reg.glmm, file = 'Table S3.txt', row.names = F, quote = T)

```

3.  Estimated Marginal Means (EMMs)

```{r}
#Biomass
biom.reg.em <- emmeans(biom.m.reg, pairwise ~ Region, type = 'response')

#EMMs contrast
biom.reg.contrast <- biom.reg.em$contrasts %>%
  as.data.frame() %>%
  mutate(Type = 'Biomass')

#Productivity
prod.reg.em <- emmeans(prod.m.reg, pairwise ~ Region, type = 'response')

#EMMs contrast
prod.reg.contrast <- prod.reg.em$contrasts %>%
  as.data.frame() %>%
  mutate(Type = 'Productivity')

#Turnover
turn.reg.em <- emmeans(turn.m.reg, pairwise ~ Region, type = 'response')

#EMMs contrast
turn.reg.contrast <- turn.reg.em$contrasts %>%
  as.data.frame() %>%
  mutate(Type = 'Turnover')

#Save emmeans pairwise comparison output
energy.reg.em <- bind_rows(biom.reg.contrast, prod.reg.contrast, turn.reg.contrast) %>%
  select(-df, -null) %>%
  mutate(across(where(is.numeric) & !p.value, ~ sprintf("%.2f", .x)),
         p.value = round(p.value, 3)) %>%
  mutate(p.value = ifelse(p.value == 0, '<0.001*', 
                          ifelse(p.value >= 0.05, sprintf("%.3f", p.value), paste0(p.value, '*')))) %>%
  relocate(Type) %>%
  rename(Dependent = Type, Contrast = contrast, Ratio = ratio, `z-ratio` = z.ratio, `p-value` = p.value)

head(energy.reg.em, 3)
#write.table(energy.reg.em, file = 'Table S4.txt', row.names = F, quote = T)

```

4.  Regional comparison boxplots

```{r, fig.width = 10, fig.height = 8}

#Position of group labels
position.reg <- transect.energy %>%
  group_by(Region) %>%
  summarise(y.biom = max(Biom) + 3,
            y.prod = max(Prod) + 0.01,
            y.turn = max(Turn) + 0.1)

### Biomass
#Formulate group labels for the boxplot
biom.reg.grp <- multcomp::cld(biom.reg.em, Letters = letters, decreasing = T) %>%
  as.data.frame() %>%
  select(Region, .group) %>%
  rename(label = .group) %>%
  left_join(., position.reg[ , c('Region', 'y.biom')], by = 'Region')

#Boxplot
region.biom <- transect.energy %>%
  ggplot(aes(x = Region, y = Biom)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(aes(col = Region), alpha = 0.75 ) +
  labs(x = 'Region', y = expression(Biomass~ ~(g%.%m^-2)),
       subtitle = 'a') +
  scale_colour_brewer(palette = "Set2", direction = -1) +
  geom_text(data = biom.reg.grp, aes(x = Region, y = y.biom, label = label), size = 5) +
  theme_bw() +
  theme(axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        plot.subtitle = element_text(size = 20),
        legend.position = 'none')

### Productivity
#Formulate group labels for the boxplot
prod.reg.grp <- multcomp::cld(prod.reg.em, Letters = letters, decreasing = T) %>%
  as.data.frame() %>%
  select(Region, .group) %>%
  rename(label = .group) %>%
  left_join(., position.reg[ , c('Region', 'y.prod')], by = 'Region')

#boxplot
region.prod <- transect.energy %>%
  ggplot(aes(x = Region, y = Prod)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(aes(col = Region), alpha = 0.75 ) +
  labs(x = 'Region', y = expression(Productivity~ ~(g%.%m^-2~~day^-1)),
       subtitle = 'b') +
  geom_text(data = prod.reg.grp, aes(x = Region, y = y.prod, label = label), size = 5) +
  scale_colour_brewer(palette = "Set2", direction = -1) +
  theme_bw() +
  theme(axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        plot.subtitle = element_text(size = 20),
        legend.position = 'none')

### Turnover
#Formulate group labels for the boxplot
turn.reg.grp <- multcomp::cld(turn.reg.em, Letters = letters, decreasing = T) %>%
  as.data.frame() %>%
  select(Region, .group) %>%
  rename(label = .group) %>%
  left_join(., position.reg[ , c('Region', 'y.turn')], by = 'Region')

#Boxplot
region.turn <- transect.energy %>%
  ggplot(aes(x = Region, y = Turn)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(aes(col = Region), alpha = 0.75 ) +
  labs(x = 'Region', y = expression(Turnover~('%'~~day^-1)), 
       subtitle = 'c') +
  geom_text(data = turn.reg.grp, aes(x = Region, y = y.turn, label = label), size = 5) +
  scale_colour_brewer(palette = "Set2", direction = -1) +
  theme_bw() +
  theme(axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        plot.subtitle = element_text(size = 20),
        legend.position = 'none')

ggarrange(region.biom, region.prod, region.turn, nrow = 2, ncol = 2, align = 'hv')
#ggsave(filename = 'Fig 3.svg', width = 10, height = 8, dpi = 1200)

```

5. Residual diagnostics for region GLMMs

```{r, fig.width=8, fig.height=9}

#svg(filename = 'Fig S3.svg', width = 8, height = 9)
layout(matrix(c(1, 2, 3, 4, 5, 6, 1, 7, 3, 8, 5, 9), nrow = 6),
       heights = c(1, 6, 1, 6, 1, 6), widths = c(2, 3))
par(mar = c(0, 0, 0, 0))
plot.new()
text(0, 0.3, 'a', cex = 2, font = 2)
par(mar = c(5, 5, 2, 1))
plotQQunif(simulateResiduals(biom.m.reg))
par(mar = c(0, 0, 0, 0))
plot.new()
text(0, 0.3, 'b', cex = 2, font = 2)
par(mar = c(5, 5, 2, 1))
plotQQunif(simulateResiduals(prod.m.reg))
par(mar = c(0, 0, 0, 0))
plot.new()
text(0, 0.3, 'c', cex = 2, font = 2)
par(mar = c(5, 5, 2, 1))
plotQQunif(simulateResiduals(turn.m.reg))
par(mar = c(5, 5, 2, 1))
plotResiduals(simulateResiduals(biom.m.reg), form = transect.energy$Region)
par(mar = c(5, 5, 2, 1))
plotResiduals(simulateResiduals(prod.m.reg), form = transect.energy$Region)
par(mar = c(5, 5, 2, 1))
plotResiduals(simulateResiduals(turn.m.reg), form = transect.energy$Region)
#dev.off()

#This plot was subsequently edited in `Inkscape` to adjust font size, text positioning, and the number of decimal digits.
```

### Energy flow contributions of different dietary groups

1.  Summarize transect-level energy flow metrics of each trophic group

```{r}

#Diet Wide table
diet.energy <- fish.metric %>%
  #Categorize 7 dietary groups into 5 groups
  mutate(Diet = ifelse(Diet %in% c('HerMac', 'HerDet'), 'Herbivore',
                       ifelse(Diet %in% c('InvMob', 'InvSes'), 'Invertivore',
                              ifelse(Diet == 'Plktiv', 'Planktivore',
                                     ifelse(Diet == 'FisCep', 'Carnivore',
                                            ifelse(Diet == 'Omnivr', 'Omnivore', NA)))))) %>%
  group_by(Transect, Diet) %>%
  #Calculate energy flows of dietary groups in each transect
  reframe(Region = Region,
          Site = Site,
          Biom = sum(Biomass)/100,
          #Growth_iter represents the average somatic growth across 100 iterations following survival simulations
          Prod = sum(Growth_iter)/100,
          Turn = Prod/Biom * 100
  ) %>%
  distinct() %>%
  #Arrange the order of diets
  mutate(Diet = factor(Diet, levels = c('Herbivore', 'Planktivore', 'Omnivore', 'Invertivore', 'Carnivore'))
  ) %>%
  relocate(Region, Site)

head(diet.energy, 3)
```

2.  A function for calculating dietary GLMMs, EMMs, and generating boxplots

```{r}

#The function takes a region as input and performs dietary GLMMs, EMMs, and generate boxplots for the given region.

Diet_glmm <- function(region_name) {
  
  #Select energy flow of the given region
  region_data <- diet.energy %>% filter(Region == region_name)
  
  energy_metric <- c("Biom", "Prod", "Turn")
  
  #Y-labels of different energy flows
  y_labels <- c(
    Biom = expression(Biomass ~ (g %.% m^{-2})),
    Prod = expression(Productivity ~ (g %.% m^{-2}~~day^{-1})),
    Turn = expression(Turnover ~ ("% day"^{-1}))
  )
  
  #Position offsets for group labels
  y_offsets <- c(Biom = 3, Prod = 0.01, Turn = 0.2)
  
  result_list <- list()
  summary_glmm_coef_list <- list()
  summary_emm_contrast_list <- list()
  
  #A loop was implemented for calculating GLMMs and EMMs for biomass, productivity, and turnover, and generating corresponding boxplots
  for (energy in energy_metric) {
    
    #GLMMs
    formula <- as.formula(paste0(energy, " ~ Diet + (1 | Site) - 1"))
    model <- glmmTMB(formula,
                     data = region_data,
                     family = ziGamma(link = "log"))
    
    #EMMs
    emm_result <- emmeans(model, pairwise ~ Diet, type = 'response')
    group_letters <- multcomp::cld(emm_result, Letters = letters, decreasing = TRUE) %>%
      as.data.frame() %>%
      select(Diet, .group) %>%
      rename(label = .group)
    
    
    #Find the max value of energy flows
    global_max <- diet.energy %>%
      summarise(
        Biom = sort(Biom, decreasing = TRUE)[2],
        Prod = max(Prod, na.rm = TRUE),
        Turn = max(Turn, na.rm = TRUE)
      ) %>%
      unlist()
    
    #Define y-limit
    y_limit <- global_max[[energy]] + y_offsets[[energy]]
    offset <- y_offsets[[energy]]
    
    #Position of group labels
    pos_df <- region_data %>%
      group_by(Diet) %>%
      summarise(y.pos = max(.data[[energy]], na.rm = TRUE) + offset, .groups = "drop")
    label_data <- left_join(group_letters, pos_df, by = "Diet")
    
    #Boxplot
    p <- ggplot(region_data, aes(x = Diet, y = .data[[energy]], fill = Diet)) +
      geom_boxplot(outlier.shape = NA) +
      geom_jitter(alpha = 0.5, cex = 0.75) +
      geom_text(data = label_data, aes(x = Diet, y = y.pos, label = label)) +
      labs(x = NULL, y = y_labels[[energy]], subtitle = region_name) +
      scale_fill_brewer(palette = "Set2") +
      scale_y_continuous(limits = c(0, y_limit)) +
      theme_bw() +
      theme(legend.position = "none",
            plot.margin = margin(2, 0.5, 1, 0.5),
            axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
            axis.title = element_text(size = 14),
            axis.text = element_text(size = 12),
            title = element_text(size = 14))
    
    #Create model summary table
    
    #GLMM output
    #Confidence interval
    ci_df <- confint(model) %>%
      as.data.frame() %>%
      tibble::rownames_to_column("Independent") %>%
      filter(!grepl("Std.Dev", Independent)) %>%
      select(-Estimate) %>%
      rename(Lower_limit = `2.5 %`, Upper_limit = `97.5 %`)
    
    #Combine the GLMM coef and the confidence interval
    coef_df <- coef(summary(model))$cond %>%
      as.data.frame() %>%
      tibble::rownames_to_column("Independent") %>%
      mutate(Dependent = energy) %>%
      left_join(ci_df, by = "Independent") %>%
      #Format the table
      mutate(Region = region_name,
             Independent = sub("^Diet", "", Independent),
             across(where(is.numeric) & !`Pr(>|z|)`, ~ sprintf("%.2f", .x)),
             `Pr(>|z|)` = round(`Pr(>|z|)`, 3)) %>%
      mutate(`Pr(>|z|)` = ifelse(`Pr(>|z|)` == 0, '<0.001*', 
                                 ifelse(`Pr(>|z|)` >= 0.05, `Pr(>|z|)`, paste0(`Pr(>|z|)`, '*')))) %>%
      relocate(Region, Dependent, Independent, Estimate, `Std. Error`, Lower_limit, Upper_limit)
    
    #Store GLMM and EMM results
    result_list[[energy]] <- list(
      model = model,
      emmeans = emm_result,
      plot = p
    )
    
    #Store the GLMM and EMM results of energy flow models into lists
    
    #GLMMs
    summary_glmm_coef_list[[energy]] <- coef_df
    
    #EMMs
    summary_emm_contrast_list[[energy]] <- emm_result$contrasts %>%
      as.data.frame() %>%
      #Add the corresponding energy flow and region in the loop
      mutate(Dependent = energy,
             Region = region_name) %>%
      relocate(Dependent, Region) %>%
      #Remove unused arguments
      select(-df, -null) %>%
      mutate(across(where(is.numeric) & !p.value, ~ sprintf("%.2f", .x)),
           p.value = round(p.value, 3)) %>%
      mutate(p.value = ifelse(p.value == 0, '<0.001*', 
                            ifelse(p.value >= 0.05, sprintf("%.3f", p.value), paste0(p.value, '*')))) %>%
      rename(Contrast = contrast, Ratio = ratio, `z-ratio` = z.ratio, `p-value` = p.value)
  }
  
  #Combine all summaries into one table
  glmm_summary <- bind_rows(summary_glmm_coef_list) %>%
    mutate(Dependent = ifelse(Dependent == 'Biom', 'Biomass',
                              ifelse(Dependent == 'Prod', 'Productivity', 'Turnover')))
  emm_contrast_summary <- bind_rows(summary_emm_contrast_list) %>%
    mutate(Dependent = ifelse(Dependent == 'Biom', 'Biomass',
                              ifelse(Dependent == 'Prod', 'Productivity', 'Turnover')))
  
  #Return all results and combined summary
  return(list(
    results = result_list,
    glmm_summary = glmm_summary,
    emm_contrast_summary = emm_contrast_summary
  ))
}

```

3.  Calculate the GLMMs, EMMs, and generate boxplots among the five regions using the function

```{r}
NT.glmm <- Diet_glmm('NT')
ET.glmm <- Diet_glmm('ET')
GI.glmm <- Diet_glmm('GI')
OI.glmm <- Diet_glmm('OI')
KT.glmm <- Diet_glmm('KT')
```

4.  Dietary boxplots

```{r, fig.width = 14, fig.height = 9.5}

#Biomass
NT.biom.plot <- NT.glmm$results$Biom$plot +
  #Add the arrow for the extreme outlier
  annotate("segment", x = 2, xend = 2, y = 24, yend = 26,
           arrow = arrow(type = "closed", length = unit(0.1, 'cm'))) +
  #Add the text for the extreme outlier
  geom_text(aes(x = 2, y = 23, label = round(max(diet.energy$Biom), 2)), col = 'black', size = 3) +
  annotate("text", x = 2, y = 18, label = 'a', col = 'black', fontface = 'plain') 
ET.biom.plot <- ET.glmm$results$Biom$plot +
  labs(y = NULL)
GI.biom.plot <- GI.glmm$results$Biom$plot+
  labs(y = NULL)
OI.biom.plot <- OI.glmm$results$Biom$plot+
  labs(y = NULL)
KT.biom.plot <- KT.glmm$results$Biom$plot+
  labs(y = NULL)

#Productivity
NT.prod.plot <- NT.glmm$results$Prod$plot
ET.prod.plot <- ET.glmm$results$Prod$plot +
  labs(y = NULL)
GI.prod.plot <- GI.glmm$results$Prod$plot+
  labs(y = NULL)
OI.prod.plot <- OI.glmm$results$Prod$plot+
  labs(y = NULL)
KT.prod.plot <- KT.glmm$results$Prod$plot+
  labs(y = NULL)

#Turnover
NT.turn.plot <- NT.glmm$results$Turn$plot
ET.turn.plot <- ET.glmm$results$Turn$plot +
  labs(y = NULL)
GI.turn.plot <- GI.glmm$results$Turn$plot+
  labs(y = NULL)
OI.turn.plot <- OI.glmm$results$Turn$plot+
  labs(y = NULL)
KT.turn.plot <- KT.glmm$results$Turn$plot+
  labs(y = NULL)

#Combine all the boxplots
diet.plot <- ggarrange(NT.biom.plot, ET.biom.plot, GI.biom.plot, OI.biom.plot, KT.biom.plot, NT.prod.plot, ET.prod.plot, GI.prod.plot, OI.prod.plot, KT.prod.plot, NT.turn.plot, ET.turn.plot, GI.turn.plot, OI.turn.plot, KT.turn.plot, nrow = 3, ncol = 5, align = 'v')

#Add a general x-label
annotate_figure(diet.plot, bottom = text_grob("Dietary group", size = 16))
#ggsave('Fig 4.svg', height = 9.5, width = 14, dpi = 1200)

#This plot was subsequently edited in `Inkscape` to adjust font size and plot positioning, and to add figure numbers and grey dashed lines to differentiate between energy flows.
```

5.  GLMM output 
```{r}
#Combine the results from the five regions
diet.glmm <- bind_rows(NT.glmm$glmm_summary,
                       ET.glmm$glmm_summary,
                       GI.glmm$glmm_summary,
                       OI.glmm$glmm_summary,
                       KT.glmm$glmm_summary) %>%
  #Assign the order of regions
  mutate(Region = factor(Region, levels = c('NT', 'ET', 'GI', 'OI', 'KT'))) %>%
  #Reorder the table following energy flows
  arrange(Dependent)

head(diet.glmm, 3)
#write.table(diet.glmm, file = 'Table S5.txt', row.names = F, quote = T)
```


6.  Post-hoc test by EMMs
```{r}
#Combine the results from the five regions
diet.compare <- bind_rows(NT.glmm$emm_contrast_summary,
                          ET.glmm$emm_contrast_summary,
                          GI.glmm$emm_contrast_summary,
                          OI.glmm$emm_contrast_summary,
                          KT.glmm$emm_contrast_summary) %>%
  #Assign the order of regions
  mutate(Region = factor(Region, levels = c('NT', 'ET', 'GI', 'OI', 'KT'))) %>%
  #Reorder the table following energy flows
  arrange(Dependent)

head(diet.compare, 3)
#write.table(diet.compare, file = 'Table S6.txt', row.names = F, quote = T)
```

### Identification of biotic drivers

1.  Import benthic composition data

```{r}
#Import benthic composition data
benthic <- read.csv(file = 'Data/Benthic composition.csv') %>%
  column_to_rownames(var = 'Transect') %>%
  #Remove substrate type, other, other life as they are not biotic factors
  select(-boulss, -limess, -rockss, -rubbus, -sandus, -siltus, -other_life, -Other) %>%
  #Remove rare species (defined as covers lower than 5% in all transect)
  select(-which(colSums(. > 0.05) == 0))

```

2.  Benthic composition PCoA

```{r, fig.width = 8, fig.height = 10}

#Bray-Curtis dissimilarity
benthic.cap <- capscale(benthic ~ 1, distance = 'bray')

#PCoA plot
#Percent explained by each axis
benthic.pcoa.per.exp <- round(100 * benthic.cap$CA$eig / sum(benthic.cap$CA$eig), 1)

#Extract PCoA 1 to 3 scores
benthic.score <- scores(benthic.cap, 1:3, 'sites') %>%
  as.data.frame() %>%
  rownames_to_column(var = 'Transect') %>%
  rename(Benthic_PCoA1 = MDS1, Benthic_PCoA2 = MDS2, Benthic_PCoA3 = MDS3)

#PCoA1-PCoA2 biplot
benthic.cap.arrow12 <- wascores(scores(benthic.cap, 1:2, 'sites'), benthic, expand = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(var = 'Species')

benthic.pcoa12.plot <- benthic.score %>%
  left_join(., fish.metric[ , c('Region', 'Transect')], by = 'Transect') %>%
  distinct() %>%
  ggplot(aes(x = Benthic_PCoA1, y = Benthic_PCoA2)) +
  geom_jitter(aes(col = Region), size = 3, alpha = 0.7) +
  scale_color_brewer(palette = "Set2", direction = -1) +
  geom_segment(data = benthic.cap.arrow12,
               aes(x = 0, xend = MDS1, y = 0, yend = MDS2),
               arrow = arrow(length = unit(0.3, "cm")), colour = "grey") +
  ggrepel::geom_text_repel(data = benthic.cap.arrow12, aes(x = MDS1, y = MDS2, label = Species), size = 3, max.overlaps = 15) +
  labs(x = paste0('PCoA1 (', benthic.pcoa.per.exp[1], '%)'),
       y = paste0('PCoA2 (', benthic.pcoa.per.exp[2], '%)')) +
  theme_bw()

#PCoA2-PCoA3 biplot
benthic.cap.arrow23 <- wascores(scores(benthic.cap, 2:3, 'sites'), benthic, expand = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(var = 'Species')

benthic.pcoa23.plot <- benthic.score %>%
  left_join(., fish.metric[ , c('Region', 'Transect')], by = 'Transect') %>%
  distinct() %>%
  ggplot(aes(x = Benthic_PCoA2, y = Benthic_PCoA3)) +
  geom_jitter(aes(col = Region), size = 3, alpha = 0.7) +
  scale_color_brewer(palette = "Set2", direction = -1) +
  geom_segment(data = benthic.cap.arrow23,
               aes(x = 0, xend = MDS2, y = 0, yend = MDS3),
               arrow = arrow(length = unit(0.3, "cm")), colour = "grey") +
  ggrepel::geom_text_repel(data = benthic.cap.arrow23, aes(x = MDS2, y = MDS3, label = Species), size = 3, max.overlaps = 15) +
  labs(x = paste0('PCoA2 (', benthic.pcoa.per.exp[2], '%)'),
       y = paste0('PCoA3 (', benthic.pcoa.per.exp[3], '%)')) +
  theme_bw()

#Combine the PCoA1-PCoA2 biplot and the PCoA2-PCoA3 biplot
ggarrange(benthic.pcoa12.plot, benthic.pcoa23.plot, nrow = 2, ncol = 1, align = 'hv')
#ggsave(filename = 'Fig S6.svg', width = 8, height = 10, dpi = 1200)

```

3.  Biotic GLMMs

```{r, fig.width = 6, fig.height = 8}

#Add region and site information to each transect
biotic.energy <- transect.energy %>%
  left_join(., benthic.score, by = 'Transect') %>%
  relocate(Region, Site) 

### Biomass
#GLMM formula
biom.f.biotic <- Biom ~ Benthic_PCoA1 + Benthic_PCoA2 + Benthic_PCoA3 + (1|Region/Site)

#GLMM
biom.m.biotic <- glmmTMB(biom.f.biotic, data = biotic.energy, family = ziGamma(link = 'log'))

#Save the GLMM output
biom.biotic.ci <- confint(biom.m.biotic) %>%
  as.data.frame() %>%
  rownames_to_column(var = 'Independent') %>%
  select(-Estimate) %>%
  rename('Lower_limit' = `2.5 %`,
         'Upper_limit' = `97.5 %`) %>%
  filter(!Independent %in% c("Std.Dev.(Intercept)|Site:Region", "Std.Dev.(Intercept)|Region"))

biom.biotic.glmm <- coef(summary(biom.m.biotic))$cond %>%
  as.data.frame() %>%
  rownames_to_column(var = 'Independent') %>%
  mutate(Dependent = 'Biomass') %>%
  left_join(., biom.biotic.ci, by = 'Independent') %>%
  relocate(Dependent) 

### Productivity
#GLMM formula
prod.f.biotic <- Prod ~ Benthic_PCoA1 + Benthic_PCoA2 + Benthic_PCoA3 + (1|Region/Site)

#GLMM
prod.m.biotic <- glmmTMB(prod.f.biotic, data = biotic.energy, family = ziGamma(link = 'log'))

#Save the GLMM output
prod.biotic.ci <- confint(prod.m.biotic) %>%
  as.data.frame() %>%
  rownames_to_column(var = 'Independent') %>%
  select(-Estimate) %>%
  rename('Lower_limit' = `2.5 %`,
         'Upper_limit' = `97.5 %`) %>%
  filter(!Independent %in% c("Std.Dev.(Intercept)|Site:Region", "Std.Dev.(Intercept)|Region"))

prod.biotic.glmm <- coef(summary(prod.m.biotic))$cond %>%
  as.data.frame() %>%
  rownames_to_column(var = 'Independent') %>%
  mutate(Dependent = 'Productivity') %>%
  left_join(., prod.biotic.ci, by = 'Independent') %>%
  relocate(Dependent)

### Turnover
#GLMM formula
turn.f.biotic <- Turn ~ Benthic_PCoA1 + Benthic_PCoA2 + Benthic_PCoA3 + (1|Region/Site)

#GLMM
turn.m.biotic <- glmmTMB(turn.f.biotic, data = biotic.energy, family = ziGamma(link = 'log'))

#Save the GLMM output
turn.biotic.ci <- confint(turn.m.biotic) %>%
  as.data.frame() %>%
  rownames_to_column(var = 'Independent') %>%
  select(-Estimate) %>%
  rename('Lower_limit' = `2.5 %`,
         'Upper_limit' = `97.5 %`) %>%
  filter(!Independent %in% c("Std.Dev.(Intercept)|Site:Region", "Std.Dev.(Intercept)|Region"))

turn.biotic.glmm <- coef(summary(turn.m.biotic))$cond %>%
  as.data.frame() %>%
  rownames_to_column(var = 'Independent') %>%
  mutate(Dependent = 'Turnover') %>%
  left_join(., turn.biotic.ci, by = 'Independent') %>%
  relocate(Dependent)

#Combine the GLMM output
energy.biotic.glmm <- bind_rows(biom.biotic.glmm, prod.biotic.glmm, turn.biotic.glmm)

#Visualize GLMM output
energy.biotic.glmm %>%
  #Label whether the variable is significant or not
  mutate(Sig = ifelse(`Pr(>|z|)` < 0.05, '*', '')) %>%
  #Arrange the order of y-axis labels
  mutate(Independent = factor(Independent, levels = c('Benthic_PCoA3', 'Benthic_PCoA2', 'Benthic_PCoA1', '(Intercept)'))) %>%
  ggplot(aes(x = Estimate, y = Independent, col = Sig)) +
  geom_pointrange(aes(xmin = Lower_limit, xmax = Upper_limit, y = Independent, col = Sig)) +
  geom_vline(xintercept = 0, col = 'black', linetype = 2, alpha = 0.3) +
  facet_wrap(vars(Dependent), ncol = 1) +
  scale_color_manual(values = c('black', 'tomato', 'tomato')) +
  labs(x = 'Estimated coefficient') +
  theme_bw() +
  theme(legend.position = 'none', axis.title.y = element_blank()) +
  theme(axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        title = element_text(size = 14),
        strip.text = element_text(size = 14))
#ggsave(filename = 'Fig 5.svg', width = 8, height = 10, dpi = 1200)

#Export GLMM output
energy.biotic.glmm <- energy.biotic.glmm %>%
  mutate(across(where(is.numeric) & !`Pr(>|z|)`, ~ sprintf("%.2f", .x)),
       `Pr(>|z|)` = round(`Pr(>|z|)`, 3)) %>%
  mutate(`Pr(>|z|)` = ifelse(`Pr(>|z|)` == 0, '<0.001*',
                             ifelse(`Pr(>|z|)` >= 0.05, `Pr(>|z|)`, paste0(`Pr(>|z|)`, '*')))) %>%
  relocate(Lower_limit, Upper_limit, .after = `Std. Error`)

head(energy.biotic.glmm, 3)
#write.table(energy.biotic.glmm, file = 'Table S7.txt', row.names = F, quote = T)

```

4. Residual diagnostics for biotic GLMMs 

```{r, fig.width=6, fig.height=8}

#svg(file = 'Fig S4.svg', width = 6, height = 8)
layout(matrix(c(1, 2, 3, 4, 5, 6, 1, 7, 3, 8, 5, 9), nrow = 6),
       heights = c(1, 6, 1, 6, 1, 6))
par(mar = c(0, 0, 0, 0))
plot.new()
text(0, 0.3, 'a', cex = 2, font = 2)
par(mar = c(5, 5, 2, 1))
plotQQunif(simulateResiduals(biom.m.biotic))
par(mar = c(0, 0, 0, 0))
plot.new()
text(0, 0.3, 'b', cex = 2, font = 2)
par(mar = c(5, 5, 2, 1))
plotQQunif(simulateResiduals(prod.m.biotic))
par(mar = c(0, 0, 0, 0))
plot.new()
text(0, 0.3, 'c', cex = 2, font = 2)
par(mar = c(5, 5, 2, 1))
plotQQunif(simulateResiduals(turn.m.biotic))
par(mar = c(5, 5, 2, 1))
plotResiduals(simulateResiduals(biom.m.biotic))
par(mar = c(5, 5, 2, 1))
plotResiduals(simulateResiduals(prod.m.biotic))
par(mar = c(5, 5, 2, 1))
plotResiduals(simulateResiduals(turn.m.biotic))
#dev.off()

#This plot was subsequently edited in `Inkscape` to adjust font size, text positioning, and the number of decimal digits.
```

5.  Relationships between energy flows and significant variables in GLMMs

```{r, fig.width = 6, fig.height = 8}

#Biomass EMMs - PCoA2 scores
biom.biotic.em.pcoa2 <- emmeans(biom.m.biotic, ~ Benthic_PCoA2, type = 'response',
                                at = list(Benthic_PCoA2 = seq(min(biotic.energy$Benthic_PCoA2, na.rm = TRUE),
                                                              max(biotic.energy$Benthic_PCoA2, na.rm = TRUE),
                                                              length.out = 250))) %>%
  as.data.frame()

#Biomass EMMs - PCoA3 scores
biom.biotic.em.pcoa3 <- emmeans(biom.m.biotic, ~ Benthic_PCoA3, type = 'response',
                                at = list(Benthic_PCoA3 = seq(min(biotic.energy$Benthic_PCoA3, na.rm = TRUE),
                                                              max(biotic.energy$Benthic_PCoA3, na.rm = TRUE),
                                                              length.out = 250))) %>%
  as.data.frame()

#Combine the PCoA2 and PCoA3 scores scores and present the results by jitter and line plot
biom.biotic.em.plot <- biotic.energy %>%
  select(-Benthic_PCoA1) %>%
  #Wide table to long table
  pivot_longer(cols = Benthic_PCoA2:Benthic_PCoA3, names_to = 'Axis', values_to = 'Score') %>%
  ggplot(aes(x = Score, y = Biom)) +
  #PCoA2 EMMs
  geom_line(aes(x = biom.biotic.em.pcoa2$Benthic_PCoA2, y = biom.biotic.em.pcoa2$response),
            col = '#66c2a5', alpha = 0.5) +
  geom_ribbon(aes(x = biom.biotic.em.pcoa2$Benthic_PCoA2, y = biom.biotic.em.pcoa2$response,
                  ymin = biom.biotic.em.pcoa2$asymp.LCL, ymax = biom.biotic.em.pcoa2$asymp.UCL),
              fill = '#66c2a5', alpha = 0.25) +
  #PCoA3 EMMs
  geom_line(aes(x = biom.biotic.em.pcoa3$Benthic_PCoA3, y = biom.biotic.em.pcoa3$response),
            alpha = 0.5, col = "#fc8d62") +
  geom_ribbon(aes(x = biom.biotic.em.pcoa3$Benthic_PCoA3, y = biom.biotic.em.pcoa3$response,
                  ymin = biom.biotic.em.pcoa3$asymp.LCL, ymax = biom.biotic.em.pcoa3$asymp.UCL),
              fill = "#fc8d62", alpha = 0.25) +
  geom_jitter(aes(col = Axis), alpha = 0.5, cex = 2) +
  scale_color_brewer(palette = "Set2") +
  labs(x = 'PCoA scores', y = expression(Biomass~ ~(g%.%m^-2)), subtitle = 'a') +
  theme_bw() +
  theme(plot.subtitle = element_text(size = 16))

#Productivity EMMs - PCoA2 scores
prod.biotic.em.pcoa2 <- emmeans(prod.m.biotic, ~ Benthic_PCoA2, type = 'response',
                                at = list(Benthic_PCoA2 = seq(min(biotic.energy$Benthic_PCoA2, na.rm = TRUE),
                                                              max(biotic.energy$Benthic_PCoA2, na.rm = TRUE),
                                                              length.out = 250))) %>%
  as.data.frame()

#Productivity EMMs - PCoA3 scores
prod.biotic.em.pcoa3 <- emmeans(prod.m.biotic, ~ Benthic_PCoA3, type = 'response',
                                at = list(Benthic_PCoA3 = seq(min(biotic.energy$Benthic_PCoA3, na.rm = TRUE),
                                                              max(biotic.energy$Benthic_PCoA3, na.rm = TRUE),
                                                              length.out = 250))) %>%
  as.data.frame()

#Combine the PCoA2 and PCoA3 scores and present the results by jitter and line plot
prod.biotic.em.plot <- biotic.energy %>%
  select(-Benthic_PCoA1) %>%
  #Wide table to long table
  pivot_longer(cols = Benthic_PCoA2:Benthic_PCoA3, names_to = 'Axis', values_to = 'Score') %>%
  ggplot(aes(x = Score, y = Prod)) +
  #PCoA2 EMMs
  geom_line(aes(x = prod.biotic.em.pcoa2$Benthic_PCoA2, y = prod.biotic.em.pcoa2$response),
            col = '#66c2a5', alpha = 0.5) +
  geom_ribbon(aes(x = prod.biotic.em.pcoa2$Benthic_PCoA2, y = prod.biotic.em.pcoa2$response,
                  ymin = prod.biotic.em.pcoa2$asymp.LCL, ymax = prod.biotic.em.pcoa2$asymp.UCL),
              fill = '#66c2a5', alpha = 0.25) +
  #PCoA3 EMMs
  geom_line(aes(x = prod.biotic.em.pcoa3$Benthic_PCoA3, y = prod.biotic.em.pcoa3$response),
            alpha = 0.5, col = "#fc8d62") +
  geom_ribbon(aes(x = prod.biotic.em.pcoa3$Benthic_PCoA3, y = prod.biotic.em.pcoa3$response,
                  ymin = prod.biotic.em.pcoa3$asymp.LCL, ymax = prod.biotic.em.pcoa3$asymp.UCL),
              fill = "#fc8d62", alpha = 0.25) +
  geom_jitter(aes(col = Axis), alpha = 0.5, cex = 2) +
  scale_color_brewer(palette = "Set2") +
  labs(x = 'PCoA scores', y = expression(Productivity~ ~(g%.%m^-2~~day^-1)), subtitle = 'b') +
  theme_bw() +
  theme(plot.subtitle = element_text(size = 16))

#Turnover - PCoA2 scores 
turn.biotic.em.pcoa2 <- emmeans(turn.m.biotic, ~ Benthic_PCoA2, type = 'response',
                                at = list(Benthic_PCoA2 = seq(min(biotic.energy$Benthic_PCoA2, na.rm = TRUE),
                                                              max(biotic.energy$Benthic_PCoA2, na.rm = TRUE),
                                                              length.out = 125))) %>%
  as.data.frame()

#Present the output by jitter and line plot
turn.biotic.em.plot <- biotic.energy  %>%
  select(-Benthic_PCoA1, -Benthic_PCoA3) %>%
  pivot_longer(cols = Benthic_PCoA2, names_to = 'Axis', values_to = 'Score') %>%
  ggplot(aes(x = Score, y = Turn)) +
  #PCoA2 EMMs
  geom_line(aes(x = turn.biotic.em.pcoa2$Benthic_PCoA2, y = turn.biotic.em.pcoa2$response),
            col = '#66c2a5', alpha = 0.5) +
  geom_ribbon(aes(x = turn.biotic.em.pcoa2$Benthic_PCoA2, y = turn.biotic.em.pcoa2$response,
                  ymin = turn.biotic.em.pcoa2$asymp.LCL, ymax = turn.biotic.em.pcoa2$asymp.UCL),
              fill = '#66c2a5', alpha = 0.25) +
  geom_jitter(aes(col = Axis), alpha = 0.5, cex = 2) +
  scale_color_brewer(palette = "Set2", direction = -1) +
  labs(x = 'PCoA scores', y = expression(Turnover~ ~("%"~~day^-1)), subtitle = 'c') +
  theme_bw() +
  theme(plot.subtitle = element_text(size = 16))

#Combine the three energy flows to the significant biotic variables plots 
ggarrange(biom.biotic.em.plot, prod.biotic.em.plot, turn.biotic.em.plot,
          nrow = 3, ncol = 1, align = 'hv')
#ggsave(filename = 'Fig S7.svg', width = 6, height = 8, dpi = 1200)

```

### Identification of abiotic drivers

1.  Import data

```{r}

#Import abiotic data
abiotic <- read.csv(file = 'Data/Abiotic variable.csv')

```

2.  Structural complexity PCA

```{r, fig.width = 8, fig.height = 6}
#Select structural complexity variables
complexity <- abiotic %>%
  select(Site, S4:SC) %>%
  column_to_rownames(var = 'Site')

#PCA estimation
complexity.stand <- decostand(complexity, method = 'stand')
complexity.cap <- capscale(complexity.stand ~ 1, distance = 'euc')

#Percent explained
complexity.pcoa.per.exp <- round(100 * complexity.cap$CA$eig / sum(complexity.cap$CA$eig), 1)

#Extract PCA 1 to 3 scores
complexity.score <- scores(complexity.cap, 1:3, 'sites') %>%
  as.data.frame() %>%
  rownames_to_column(var = 'Site') %>%
  rename(Complexity_PCA1 = MDS1, Complexity_PCA2 = MDS2, Complexity_PCA3 = MDS3)

#PCA1-PCA2
complexity.cap.arrow12 <- wascores(scores(complexity.cap, 1:2, 'sites'), complexity, expand = TRUE) %>%
  as.data.frame() %>%
  rownames_to_column(var = 'Species')

#The PCA plot of structural complexity
complexity.score %>%
  left_join(., fish.metric[ , c('Region', 'Site')], by = 'Site') %>%
  distinct() %>%
  ggplot(aes(x = Complexity_PCA1, y = Complexity_PCA2)) +
  geom_jitter(aes(col = Region), size = 3, alpha = 0.7) +
  scale_color_brewer(palette = "Set2", direction = -1) +
  geom_segment(data = complexity.cap.arrow12,
               aes(x = 0, xend = MDS1, y = 0, yend = MDS2),
               arrow = arrow(length = unit(0.3, "cm")), colour = "grey") +
  ggrepel::geom_text_repel(data = complexity.cap.arrow12, aes(x = MDS1, y = MDS2, label = Species), size = 3, max.overlaps = 15) +
  labs(x = sprintf('PCA1 ( %.1f%%)', complexity.pcoa.per.exp[1]),
       y = paste0('PCA2 (', complexity.pcoa.per.exp[2], '%)')) +
  theme_bw()
#ggsave(filename = 'Fig S8.svg', width = 8, height = 6, dpi = 1200)

```

3.  QQ-plots and histograms of fish energy flows at site-level

```{r, fig.height = 8, fig.width = 7}
### Site-level energy flow metric ###
abiotic.energy <- fish.metric %>%
  #Energy flows in each transect
  group_by(Region, Site, Transect) %>%
  summarise(Biom = sum(Biomass)/100,
            #Growth_iter represents the average somatic growth across 100 iterations following survival simulations
            Prod = sum(Growth_iter)/100,
            .groups = 'drop') %>%
  #Site level energy metrics (to incorporate with complexity and other abiotic variables)
  group_by(Region, Site) %>%
  summarise(Biom = mean(Biom),
            Prod = mean(Prod),
            Turn = Prod/Biom * 100,
            .groups = 'drop')  %>%
  #Combine energy flows with the explanatory variables
  left_join(., complexity.score, by = 'Site') %>%
  left_join(., abiotic, by = 'Site') %>%
  mutate(Site = as.character(Site),
         Region = as.character(Region),
         #log transform human population
         Human_pop = log10(Human_pop),
         #Standardize all the variables
         across(.cols = Complexity_PCA1:SC, ~ decostand(.x, 2, method = 'stand'))
  )

### QQ-plots and histograms of fish energy flows ###
#Biomass
site.biom.qq <- abiotic.energy %>%
  ggplot(aes(sample = Biom)) +
  stat_qq(pch = 1, cex = 2) +
  stat_qq_line() +
  labs(x = 'Theoretical Quantiles', y = 'Sample Quantiles', subtitle = 'a') +
  theme_bw() +
  theme(panel.grid = element_blank(),
        plot.subtitle = element_text(size = 16))

site.biom.density <- abiotic.energy %>%
  ggplot(aes(x = Biom)) +
  geom_histogram(aes(y = after_stat(density)), col = 'black', fill = 'grey75', bins = 15) +
  geom_density() +
  labs(x = expression(Biomass~ ~(g%.%m^-2)), y = 'Density', subtitle = ' ') +
  theme_bw() +
  theme(panel.grid = element_blank())

#Productivity
site.prod.qq <- abiotic.energy %>%
  ggplot(aes(sample = Prod)) +
  stat_qq(pch = 1, cex = 2) +
  stat_qq_line() +
  labs(x = 'Theoretical Quantiles', y = 'Sample Quantiles', subtitle = 'b') +
  theme_bw() +
  theme(panel.grid = element_blank(),
        plot.subtitle = element_text(size = 16))

site.prod.density <- abiotic.energy %>%
  ggplot(aes(x = Prod)) +
  geom_histogram(aes(y = after_stat(density)), col = 'black', fill = 'grey75', bins = 15) +
  geom_density() +
  labs(x = expression(Productivity~ ~(g%.%m^-2~~day^-1)), y = 'Density', subtitle = ' ') +
  scale_x_continuous(breaks = seq(0, 0.06, 0.02)) +
  theme_bw() +
  theme(panel.grid = element_blank())

#Turnover
site.turn.qq <- abiotic.energy %>%
  ggplot(aes(sample = Turn)) +
  stat_qq(pch = 1, cex = 2) +
  stat_qq_line() +
  labs(x = 'Theoretical Quantiles', y = 'Sample Quantiles', subtitle = 'c') +
  theme_bw() +
  theme(panel.grid = element_blank(),
        plot.subtitle = element_text(size = 16))

site.turn.density <- abiotic.energy %>%
  ggplot(aes(x = Turn)) +
  geom_histogram(aes(y = after_stat(density)), col = 'black', fill = 'grey75', bins = 15) +
  geom_density() +
  labs(x = expression(Turnover~('%'~~day^-1)), y = 'Density', subtitle = ' ') +
  theme_bw() +
  theme(panel.grid = element_blank())

#Combine all the plots
ggarrange(site.biom.qq, site.biom.density, site.prod.qq, site.prod.density, site.turn.qq, site.turn.density,
          nrow = 3, ncol = 2, align = 'hv')
#ggsave(filename = 'Fig S2.svg', height = 8, width = 7, units = 'in', dpi = 1200)

```

4.  Abiotic GLMMs

```{r, fig.width = 6, fig.height = 8}
### Abiotic GLMMs ###

### Biomass 
#GLMM formula
biom.f.abiotic <- Biom ~ Human_pop + PP + SST + SS + US + Complexity_PCA1 + Complexity_PCA2 + Complexity_PCA3 + (1|Region)

#GLMM
biom.m.abiotic <- glmmTMB(biom.f.abiotic, data = abiotic.energy, family = ziGamma(link = 'log'))

#Save the GLMM output
biom.abiotic.ci <- confint(biom.m.abiotic) %>%
  as.data.frame() %>%
  rownames_to_column(var = 'Independent') %>%
  select(-Estimate) %>%
  rename('Lower_limit' = `2.5 %`,
         'Upper_limit' = `97.5 %`) %>%
  filter(Independent != "Std.Dev.(Intercept)|Region")

biom.abiotic.glmm <- coef(summary(biom.m.abiotic))$cond %>%
  as.data.frame() %>%
  rownames_to_column(var = 'Independent') %>%
  mutate(Dependent = 'Biomass') %>%
  left_join(., biom.abiotic.ci, by = 'Independent') %>%
  relocate(Dependent)

### Productivity 
#GLMM formula
prod.f.abiotic <- Prod ~ Human_pop + PP + SST + SS + US + Complexity_PCA1 + Complexity_PCA2 + Complexity_PCA3 + (1|Region)

#GLMM
prod.m.abiotic <- glmmTMB(prod.f.abiotic, data = abiotic.energy, family = ziGamma(link = 'log'))

#Save the GLMM output
prod.abiotic.ci <- confint(prod.m.abiotic) %>%
  as.data.frame() %>%
  rownames_to_column(var = 'Independent') %>%
  select(-Estimate) %>%
  rename('Lower_limit' = `2.5 %`,
         'Upper_limit' = `97.5 %`) %>%
  filter(Independent != "Std.Dev.(Intercept)|Region")

prod.abiotic.glmm <- coef(summary(prod.m.abiotic))$cond %>%
  as.data.frame() %>%
  rownames_to_column(var = 'Independent') %>%
  mutate(Dependent = 'Productivity') %>%
  left_join(., prod.abiotic.ci, by = 'Independent') %>%
  relocate(Dependent)

### Turnover 
#GLMM formula
turn.f.abiotic <- Turn ~ Human_pop + PP + SST + SS + US + Complexity_PCA1 + Complexity_PCA2 + Complexity_PCA3 + (1|Region)

#GLMM
turn.m.abiotic <- glmmTMB(turn.f.abiotic, data = abiotic.energy, family = ziGamma(link = 'log'))

#Save the GLMM output
turn.abiotic.ci <- confint(turn.m.abiotic) %>%
  as.data.frame() %>%
  rownames_to_column(var = 'Independent') %>%
  select(-Estimate) %>%
  rename('Lower_limit' = `2.5 %`,
         'Upper_limit' = `97.5 %`) %>%
  filter(Independent != "Std.Dev.(Intercept)|Region")

turn.abiotic.glmm <- coef(summary(turn.m.abiotic))$cond %>%
  as.data.frame() %>%
  rownames_to_column(var = 'Independent') %>%
  mutate(Dependent = 'Turnover') %>%
  left_join(., turn.abiotic.ci, by = 'Independent') %>%
  relocate(Dependent)

#Summarize the GLMM output
energy.abiotic.glmm <- bind_rows(biom.abiotic.glmm, prod.abiotic.glmm, turn.abiotic.glmm) 

#Visualize GLMM output
energy.abiotic.glmm %>%
  #Label whether the variable is significant or not
  mutate(Sig = ifelse(`Pr(>|z|)` < 0.05, '*', '')) %>%
  #Arrange the order of y-axis labels
  mutate(Independent = factor(Independent, levels = c('Complexity_PCA3', 'Complexity_PCA2', 'Complexity_PCA1', 'SS', 'US', 'SST', 'PP', 'Human_pop', '(Intercept)'))) %>%
  ggplot(aes(x = Estimate, y = Independent, col = Sig)) +
  geom_pointrange(aes(xmin = Lower_limit, xmax = Upper_limit, y = Independent, col = Sig)) +
  geom_vline(xintercept = 0, col = 'black', linetype = 2, alpha = 0.3) +
  facet_wrap(vars(Dependent), ncol = 1) +
  scale_color_manual(values = c('black', 'tomato')) +
  labs(x = 'Estimated coefficient') +
  theme_bw() +
  theme(legend.position = 'none', axis.title.y = element_blank()) +
  theme(axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        title = element_text(size = 14),
        strip.text = element_text(size = 14))
#ggsave(filename = 'Fig 6.svg', width = 8, height = 10, dpi = 1200)

#Export the GLMM output
energy.abiotic.glmm <- energy.abiotic.glmm %>%
  mutate(across(where(is.numeric) & !`Pr(>|z|)`, ~ round(.x, 2)),
         `Pr(>|z|)` = round(`Pr(>|z|)`, 3)) %>%
  mutate(`Pr(>|z|)` = ifelse(`Pr(>|z|)` == 0, '<0.001*', 
                             ifelse(`Pr(>|z|)` >= 0.05, `Pr(>|z|)`, paste0(`Pr(>|z|)`, '*')))) %>%
  relocate(Lower_limit, Upper_limit, .after = `Std. Error`)

head(energy.abiotic.glmm, 3)
#write.table(energy.abiotic.glmm, file = 'Table S8.txt', row.names = F, quote = T)

```

5.  Residual diagnostics for abiotic GLMMs

```{r, fig.width = 6, fig.height = 8}

#svg(file = 'Fig S5.svg', width = 6, height = 8)
layout(matrix(c(1, 2, 3, 4, 5, 6, 1, 7, 3, 8, 5, 9), nrow = 6),
       heights = c(1, 6, 1, 6, 1, 6))
par(mar = c(0, 0, 0, 0))
plot.new()
text(0, 0.3, 'a', cex = 2, font = 2)
par(mar = c(5, 5, 2, 1))
plotQQunif(simulateResiduals(biom.m.abiotic))
par(mar = c(0, 0, 0, 0))
plot.new()
text(0, 0.3, 'b', cex = 2, font = 2)
par(mar = c(5, 5, 2, 1))
plotQQunif(simulateResiduals(prod.m.abiotic))
par(mar = c(0, 0, 0, 0))
plot.new()
text(0, 0.3, 'c', cex = 2, font = 2)
par(mar = c(5, 5, 2, 1))
plotQQunif(simulateResiduals(turn.m.abiotic))
par(mar = c(5, 5, 2, 1))
plotResiduals(simulateResiduals(biom.m.abiotic))
par(mar = c(5, 5, 2, 1))
plotResiduals(simulateResiduals(prod.m.abiotic))
par(mar = c(5, 5, 2, 1))
plotResiduals(simulateResiduals(turn.m.abiotic))
#dev.off()

#This plot was subsequently edited in `Inkscape` to adjust font size, text positioning, and the number of decimal digits.
```

6.  Check collinearity in abiotic GLMMs 

```{r}

abiotic.glmm.vif <- bind_rows(check_collinearity(biom.m.abiotic), check_collinearity(prod.m.abiotic), check_collinearity(turn.m.abiotic)) %>%
  mutate(Independent = rep(c('Biomass', 'Productivity', 'Turnover'), each = 8),
         across(where(is.numeric), ~ sprintf("%.2f", .x))) %>%
  as.data.frame() %>%
  select(Independent, Term, VIF, VIF_CI_low, VIF_CI_high) %>%
  rename(`Fix effect` = Term, `Lower limit` = VIF_CI_low , `Upper limit` = VIF_CI_high)

head(abiotic.glmm.vif, 3)
#write.table(abiotic.glmm.vif, file = 'Table S9.txt', row.names = F, quote = T)

```

7.  Relationships between energy flows and significant variables in GLMMs 
```{r, fig.width = 6, fig.height = 8}

#Biomass - Stable Substrate
biom.abiotic.em.ss <- emmeans(biom.m.abiotic, ~ SS, type = 'response',
                              at = list(SS = seq(min(abiotic.energy$SS, na.rm = TRUE),
                                                 max(abiotic.energy$SS, na.rm = TRUE),
                                                 length.out = 50))) %>%
  as.data.frame()

#Biomass - structural complexity PCA1
biom.abiotic.em.comp1 <- emmeans(biom.m.abiotic, ~ Complexity_PCA1, type = 'response',
                                 at = list(Complexity_PCA1 = seq(min(abiotic.energy$Complexity_PCA1, na.rm = TRUE),
                                                                 max(abiotic.energy$Complexity_PCA1, na.rm = TRUE),
                                                                 length.out = 50))) %>%
  as.data.frame()

#Combine the SS and PCA1 values and present the results by jitter and line plot
biom.abiotic.em.plot <- abiotic.energy %>%
  select(Biom, SS, Complexity_PCA1) %>%
  pivot_longer(cols = SS:Complexity_PCA1, names_to = 'Variable', values_to = 'Score') %>%
  mutate(Variable = factor(Variable, levels = c('SS', 'Complexity_PCA1'))) %>%
  ggplot(aes(x = Score, y = Biom)) +
  #SS EMMs
  geom_line(aes(x = biom.abiotic.em.ss$SS, y = biom.abiotic.em.ss$response),
            col = '#66c2a5', alpha = 0.5) +
  geom_ribbon(aes(x = biom.abiotic.em.ss$SS, y = biom.abiotic.em.ss$response,
                  ymin = biom.abiotic.em.ss$asymp.LCL, ymax = biom.abiotic.em.ss$asymp.UCL),
              fill = '#66c2a5', alpha = 0.25) +
  #Complexity PCA1 EMMs
  geom_line(aes(x = biom.abiotic.em.comp1$Complexity_PCA1, y = biom.abiotic.em.comp1$response),
            alpha = 0.5, col = "#fc8d62") +
  geom_ribbon(aes(x = biom.abiotic.em.comp1$Complexity_PCA1, y = biom.abiotic.em.comp1$response,
                  ymin = biom.abiotic.em.comp1$asymp.LCL, ymax = biom.abiotic.em.comp1$asymp.UCL),
              fill = "#fc8d62", alpha = 0.25) +
  geom_jitter(aes(col = Variable), alpha = 0.5, cex = 2) +
  scale_color_brewer(palette = "Set2") +
  labs(x = 'Standardized values', y = expression(Biomass~ ~(g%.%m^-2)), subtitle = 'a') +
  theme_bw() +
  theme(plot.subtitle = element_text(size = 14))

#Productivity
prod.abiotic.em.ss <- emmeans(prod.m.abiotic, ~ SS, type = 'response',
                              at = list(SS = seq(min(abiotic.energy$SS, na.rm = TRUE),
                                                 max(abiotic.energy$SS, na.rm = TRUE),
                                                 length.out = 50))) %>%
  as.data.frame()

prod.abiotic.em.comp1 <- emmeans(prod.m.abiotic, ~ Complexity_PCA1, type = 'response',
                                 at = list(Complexity_PCA1 = seq(min(abiotic.energy$Complexity_PCA1, na.rm = TRUE),
                                                                 max(abiotic.energy$Complexity_PCA1, na.rm = TRUE),
                                                                 length.out = 50))) %>%
  as.data.frame()

#Combine the SS and PCA1 values and present the results by jitter and line plot
prod.abiotic.em.plot <- abiotic.energy %>%
  select(Prod, SS, Complexity_PCA1) %>%
  pivot_longer(cols = SS:Complexity_PCA1, names_to = 'Variable', values_to = 'Score') %>%
  mutate(Variable = factor(Variable, levels = c('SS', 'Complexity_PCA1'))) %>%
  ggplot(aes(x = Score, y = Prod)) +
  #SS EMMs
  geom_line(aes(x = prod.abiotic.em.ss$SS, y = prod.abiotic.em.ss$response),
            col = '#66c2a5', alpha = 0.5) +
  geom_ribbon(aes(x = prod.abiotic.em.ss$SS, y = prod.abiotic.em.ss$response,
                  ymin = prod.abiotic.em.ss$asymp.LCL, ymax = prod.abiotic.em.ss$asymp.UCL),
              fill = '#66c2a5', alpha = 0.25) +
  #Complexity PCA1 EMMs
  geom_line(aes(x = prod.abiotic.em.comp1$Complexity_PCA1, y = prod.abiotic.em.comp1$response),
            alpha = 0.5, col = "#fc8d62") +
  geom_ribbon(aes(x = prod.abiotic.em.comp1$Complexity_PCA1, y = prod.abiotic.em.comp1$response,
                  ymin = prod.abiotic.em.comp1$asymp.LCL, ymax = prod.abiotic.em.comp1$asymp.UCL),
              fill = "#fc8d62", alpha = 0.25) +
  geom_jitter(aes(col = Variable), alpha = 0.5, cex = 2) +
  scale_color_brewer(palette = "Set2") +
  labs(x = 'Standardized values', y = expression(Productivity~ ~(g%.%m^-2~~day^-1)), subtitle = 'b') +
  theme_bw()+
  theme(plot.subtitle = element_text(size = 14))

#Turnover - Stable substrate
turn.abiotic.em.ss <- emmeans(turn.m.abiotic, ~ SS, type = 'response',
                              at = list(SS = seq(min(abiotic.energy$SS, na.rm = TRUE),
                                                 max(abiotic.energy$SS, na.rm = TRUE),
                                                 length.out = 25))) %>%
  as.data.frame()

#Present the output by jitter and line plot
turn.abiotic.em.plot <- abiotic.energy %>%
  select(Turn, SS) %>%
  pivot_longer(cols = SS, names_to = 'Variable', values_to = 'Score') %>%
  ggplot(aes(x = Score, y = Turn)) +
  #SS EMMs
  geom_line(aes(x = turn.abiotic.em.ss$SS, y = turn.abiotic.em.ss$response),
            col = '#66c2a5', alpha = 0.5) +
  geom_ribbon(aes(x = turn.abiotic.em.ss$SS, y = turn.abiotic.em.ss$response,
                  ymin = turn.abiotic.em.ss$asymp.LCL, ymax = turn.abiotic.em.ss$asymp.UCL),
              fill = '#66c2a5', alpha = 0.25) +
  geom_jitter(aes(col = Variable), alpha = 0.5, cex = 2) +
  scale_color_brewer(palette = "Set2") +
  labs(x = 'Standardized values', y = expression(Turnover~ ~("%"~~day^-1)), subtitle = 'c') +
  theme_bw() +
  theme(plot.subtitle = element_text(size = 14))

#Combine the three energy flows to the significant abiotic variables plots 
ggarrange(biom.abiotic.em.plot, prod.abiotic.em.plot, turn.abiotic.em.plot,
          nrow = 3, ncol = 1, align = 'hv')
#ggsave('Fig S9.svg', width = 6, height = 8, dpi = 1200)

#This plot was subsequently edited in `Inkscape` to adjust legend positioning.
```